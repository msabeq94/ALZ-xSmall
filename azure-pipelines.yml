trigger: none

pool: default

parameters:
  - name: customer_client_id
    displayName: "Customer Client ID"
    type: object
    default: "f084242d-5811-4cac-accc-4377318b9e39"

  - name: customer_client_secret
    displayName: "Customer Client Secret"
    type: object
    default: "g9w8Q~zt.EResb09c_icBvcLrWILVHuZ.-k0NbeS"
  
  - name: customer_tenant_id
    displayName: "Customer Tenant ID"
    type: object
    default: "87431d80-c13c-4f97-8d52-4bd5ec6e617e"

  - name: customer_subscription_id
    displayName: "Customer Subscription ID"
    type: object
    default: "102170e2-9371-4b66-95de-d4530f8bf56e"

  - name: customer_name
    displayName: "Customer Name"
    type: object
    default: "mos"

  - name: customer_location
    displayName: "Customer location"
    type: object
    default: "eastus"

  - name: dateYMD
    displayName: "dateYMD"
    type: object
    default: "$(date +%Y%m%dT%H%M%S%NZ)"

  - name: NAME
    displayName: "NAME"
    type: object
    default: "alz-MgDeployment-mos"

stages:
- stage: Stage1
  jobs:
  - job: login
    steps:
    - script: az login --service-principal --username ${{ parameters.customer_client_id}} --password ${{ parameters.customer_client_secret }} --tenant ${{ parameters.customer_tenant_id }}
      displayName: 'login'
      
# - stage: Stage2
#   dependsOn: Stage1
#   jobs:
#   - job: Run_bicep_file_MG
#     steps:
#     - script: | 
#         sed -i "s/customerName/${{parameters.customer_name}}/g" managementGroups.parameters.XSmall.json
#         az deployment tenant create --name ${{parameters.NAME}}  --location ${{parameters.customer_location}} --template-file "managementGroupsXSmall.bicep"  --parameters "managementGroups.parameters.XSmall.json"
#       displayName: 'Run_bicep_file_MG'

- stage: Stage3
  dependsOn: Stage1
  jobs:
  - job: Run_bicep_file_MAIN
    steps:
    - script: |
        sed -i "s/customerLocation/${{parameters.customer_location}}/g" Main.parameters.XSmall.json
        sed -i "s/mgmtSubID/${{parameters.customer_subscription_id}}/g" Main.parameters.XSmall.json
        sed -i "s/mgmtSubID/${{parameters.customer_subscription_id}}/g" Modules/FWXSmall.bicep
        sed -i "s/mgmtSubID/${{parameters.customer_subscription_id}}/g" Modules/PolicyassignmentsXSmall.bicep
        az deployment sub create --name ${{parameters.NAME}}  --location ${{parameters.customer_location}} --template-file "MainXSmall.bicep"  --parameters "Main.parameters.XSmall.json"
      displayName: 'Run Bicep MAIN file'

- stage: Stage4
  dependsOn: Stage3
  jobs:
  - job: manual_approval
    displayName: "Manual Approval Step"
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: 'msabeq@outlook.com'  # Replace with the email(s) of approvers
        instructions: 'Please approve or reject the execution of Stage4.'
  - job: Run_bicep_file_MAIN
    dependsOn: manual_approval
    steps:
    - script: |
        az group delete --name "vf-core-InternalServices-rg" --yes 
        az group delete --name "vf-core-Production-rg" --yes 
        az group delete --name "vf-core-Development-rg" --yes 
        az group delete --name "vf-core-CentralHub-rg" --yes 
      displayName: 'Run Bicep RM-RG'
